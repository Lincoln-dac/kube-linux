一、velero 简介
Velero 是vmware开源的一个云原生的灾难恢复和迁移工具，它本身也是开源的,采用Go语言编写，可以安全的备份、恢复和迁移Kubernetes集群资源数据；
Velero 是西班牙语意思是帆船，非常符合Kubernetes社区的命名风格，Velero的开发公司Heptio，已被VMware收购。Velero 支持标准的K8S集群，
既可以是私有云平台也可以是公有云，除了灾备之外它还能做资源移转，支持把容器应用从一个集群迁移到另一个集群。
Velero 的工作方式就是把kubernetes中的数据备份到对象存储以实现高可用和持久化，默认的备份保存时间为720小时，并在需要的时候进行下载和恢复。

github: https://github.com/vmware-tanzu/velero
官网：https://velero.io/

![image](https://github.com/Lincoln-dac/kube-linux/blob/master/pic/velero1.png)


二、 velero 和 ETCD 备份的区别

2.1 velero 备份
Velero 是一个开源工具，用于备份和恢复 Kubernetes 集群中的资源和持久化数据。它支持对 Kubernetes 资源（如 Pods、Services、Deployments 等）和持久卷（Persistent Volumes）进行备份和恢复。

主要特点：

备份 Kubernetes 资源：包括集群的 API 对象和元数据。
备份持久化数据：通过与存储供应商（如 AWS S3、Azure Blob、Google Cloud Storage 等）集成，备份 PVC 中的数据。
备份计划：可以设置定期备份和备份策略。
迁移支持：可以用于跨集群或跨云的迁移。
恢复功能：支持恢复整个集群或部分资源。
使用场景：

需要备份和恢复整个 Kubernetes 集群的配置和持久化数据。
需要支持跨集群的迁移。
需要定期备份和恢复 Kubernetes 对象和 PVC 数据。
2.2 etcd 备份
etcd 是 Kubernetes 的核心组件之一，存储了集群的所有状态和配置信息。etcd 备份 是针对 etcd 数据库的备份，主要用于备份和恢复 Kubernetes 的集群状态和配置。

主要特点：

备份 Kubernetes 状态：包括集群的所有配置和状态数据。
原生备份：直接备份 etcd 数据库，而不是通过 Kubernetes API。
恢复集群状态：可以恢复整个集群的状态到备份时的状态。
使用场景：

需要备份和恢复 Kubernetes 集群的核心状态和配置信息。
需要恢复集群的状态到某个时间点。
需要直接操作 etcd 数据库进行备份和恢复。
2.3 对比

特性	    Velero	etcd 备份
备份内容	Kubernetes 资源和持久卷	etcd 数据库（集群状态和配置）
备份方式	通过 Velero CLI，存储在外部存储	使用 etcdctl 工具，存储在指定位置
恢复内容	Kubernetes 资源和持久卷	恢复集群的状态和配置
使用场景	跨集群迁移、集群资源备份与恢复	集群状态恢复、紧急恢复
自动化	支持定期备份和恢复策略	通常手动执行备份和恢复
2.4.选择建议
使用 Velero 如果你需要备份和恢复整个 Kubernetes 集群的资源和持久化数据，包括跨集群迁移和定期备份。
使用 etcd 备份 如果你专注于备份和恢复 Kubernetes 的核心状态和配置，特别是在需要恢复整个集群状态到某个时间点时。
有时，你可能需要同时使用这两种备份策略，以确保全面的数据保护和恢复能力。例如，你可以使用 Velero 备份 Kubernetes 资源和持久卷，而使用 etcd 备份来保护集群的核心状态和配置； 本文呢 主要阐述对 velero 的备份详解

三、velero整体架构

![image](https://github.com/Lincoln-dac/kube-linux/blob/master/pic/velero2.png)
需要部署一个 Velero 服务端到集群，该服务端拥有访问集群资源的权限；
通过 velero 二进制程序部署服务端的同时，其也会向 kubernetes 集群中同时注册一些 crd 资源，这些 crd 资源可以对我们备份、还原的资源做抽象；
通过 crd 资源创建一个备份请求对象，服务端控制器会根据请求内容完成目标预期的备份，并将备份后的文件上传至配置的远端存储（需要支持 S3 协议，如 Ceph、Minio 都可以）；
备份完毕后，可以通过获取特定的 crd 资源来查看备份的记录（文件）；
通过 crd 资源创建一个还原请求对象，服务端控制器会根据请求内容对应的备份文件，将备份内容恢复到集群；

四、velero备份流程

![image](https://github.com/Lincoln-dac/kube-linux/blob/master/pic/velero3.png)

Velero 客户端调用Kubernetes API Server创建Backup任务。
Backup 控制器基于watch 机制通过API Server获取到备份任务。
Backup 控制器开始执行备份动作，其会通过请求API Server获取需要备份的数据。
Backup 控制器将获取到的数据备份到指定的对象存储server端。

五、集群迁移示例
实验目的：

在两个集群迁移 kubernetes 资源需要进行的动作，使用velero，将 A 集群 default 名称空间及其下的资源迁移到 B 集群
大致步骤：

部署一个 minio，用来作为 Velero 上传备份文件的远端存储；
在两个 kubernetes 集群中都部署一个 Velero 服务端，这两个服务端的远端存储都配置同一个 minio，且指定使用同一个 bucket；
在 A 集群中创建一个对 default 名称空间的备份请求，确认备份动作执行完毕；
登录 B 集群 查看 A 集群中 备份的记录文件；
在B 集群创建一个还原请求，将 A 集群备份的文件还原到 B 集群；
在B 集群验证 default 命名空间下的资源 是否正确。