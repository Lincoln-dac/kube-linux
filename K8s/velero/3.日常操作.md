一、安装与配置
1.1 安装 Velero 客户端  
wget https://github.com/vmware-tanzu/velero/releases/download/v1.4.2/velero-v1.4.2-linux-amd64.tar.gz
解压velero-v1.4.2-linux-amd64.tar.gz
tar -zxvf velero-v1.4.2-linux-amd64.tar.gz
cd /app/velero-v1.4.2-linux-amd64   
mv velero /usr/local/bin/
1.2 查看安装状态
# 查看 Velero pod
kubectl get pods -n velero

# 查看 Velero 部署
kubectl get deployment -n velero

# 查看 Velero 日志
kubectl logs deployment/velero -n velero -f

# 检查插件状态
velero plugin get

二、备份操作

2.1 创建备份

# 1. 完整集群备份（排除 velero 命名空间）
velero backup create full-cluster-backup --exclude-namespaces velero

# 2. 备份特定命名空间
velero backup create ns-backup --include-namespaces kube-system,default

# 3. 备份带标签的资源
velero backup create labeled-backup --selector app=nginx,env=prod

# 4. 排除特定命名空间
velero backup create exclude-backup --exclude-namespaces kube-public,temp

# 5. 仅备份特定资源类型
velero backup create selective-backup \
  --include-resources deployments,configmaps,secrets

# 6. 设置备份过期时间（TTL）
velero backup create ttl-backup --ttl 720h  # 30天

# 7. 备份时添加注释
velero backup create annotated-backup \
  --labels backup-type=full \
  --annotations creator=admin,env=production

# 8. 增量备份（需要快照支持）
velero backup create incremental-backup --snapshot-volumes

# 9. 备份特定存储类
velero backup create storage-backup --include-storage-classes fast,ssd

# 10. 备份排除特定资源
velero backup create exclude-resources \
  --exclude-resources pods,events

# 11. 并行备份多个命名空间
velero backup create parallel-backup \
  --include-namespaces ns1,ns2,ns3 \
  --ordered-resources 'pods=ns1/pod1,ns1/pod2;deployments=ns2/deploy1'

# 12. 查看备份列表
velero backup get

# 13. 查看备份详情
velero backup describe <backup-name>

# 14. 删除备份
velero backup delete <backup-name>


2.2 备份调度
# 1. 创建每日备份调度
velero schedule create daily-backup --schedule="0 2 * * *"

# 2. 创建每小时备份
velero schedule create hourly-backup --schedule="@every 1h"

# 3. 创建每周日备份
velero schedule create weekly-backup --schedule="0 2 * * 0"

# 4. 带保留策略的调度
velero schedule create retention-backup \
  --schedule="0 2 * * *" \
  --ttl 168h \  # 保留7天
  --labels backup-type=daily

# 5. 特定命名空间的调度
velero schedule create ns-schedule \
  --schedule="0 3 * * *" \
  --include-namespaces production

# 6. 查看调度
velero schedule get
velero schedule describe <schedule-name>

# 7. 暂停调度
velero schedule pause <schedule-name>

# 8. 恢复调度
velero schedule unpause <schedule-name>

# 9. 删除调度
velero schedule delete <schedule-name>

2.3 备份管理

# 1. 查看所有备份
velero backup get
kubectl get backups -n velero

# 2. 查看备份详情
velero backup describe <backup-name>
velero backup describe <backup-name> --details

# 3. 查看备份日志
velero backup logs <backup-name>
velero backup logs <backup-name> --timestamps

# 4. 下载备份文件
velero backup download <backup-name>

# 5. 查看备份中的资源
velero backup describe <backup-name> | grep -A 50 "Resource List"

# 6. 检查备份状态
velero backup describe <backup-name> --output jsonpath='{.status.phase}'

# 7. 备份统计信息
velero backup describe <backup-name> --output json | jq '.status'

# 8. 备份标签管理
velero backup get --selector env=production
velero backup get -l backup-type=daily


三、恢复操作

3.1 恢复备份

# 1. 完全恢复（恢复到原命名空间）
velero restore create full-restore --from-backup <backup-name>

# 2. 恢复到不同命名空间
velero restore create restore-ns-mapping \
  --from-backup <backup-name> \
  --namespace-mappings old-ns:new-ns

# 3. 仅恢复特定资源
velero restore create partial-restore \
  --from-backup <backup-name> \
  --include-resources deployments,services,configmaps

# 4. 恢复特定命名空间
velero restore create ns-restore \
  --from-backup <backup-name> \
  --include-namespaces default,production

# 5. 使用标签选择器恢复
velero restore create labeled-restore \
  --from-backup <backup-name> \
  --selector app=critical

# 6. 恢复时重命名资源
velero restore create rename-restore \
  --from-backup <backup-name> \
  --rename-resource deployments=deployments.renamed \
  --rename-resource configmaps=configmaps.renamed

# 7. 恢复策略设置
velero restore create policy-restore \
  --from-backup <backup-name> \
  --existing-resource-policy update  # none, update, or preserve

# 8. 并行恢复
velero restore create parallel-restore \
  --from-backup <backup-name> \
  --parallel-files-upload 5 \
  --write-s3-buffer-size 10485760

# 9. 恢复特定资源名称
velero restore create specific-resource \
  --from-backup <backup-name> \
  --include-resource-filters "deployments=my-deployment" \
  --include-resource-filters "configmaps=my-config"

# 10. 恢复排除资源
velero restore create exclude-restore \
  --from-backup <backup-name> \
  --exclude-resources secrets,events

3.2 恢复管理
# 1. 查看所有恢复
velero restore get
kubectl get restores -n velero

# 2. 查看恢复详情
velero restore describe <restore-name>
velero restore describe <restore-name> --details

# 3. 查看恢复日志
velero restore logs <restore-name>
velero restore logs <restore-name> --timestamps

# 4. 查看恢复资源
velero restore describe <restore-name> | grep -A 50 "Restored Resource List"

# 5. 恢复状态检查
velero restore describe <restore-name> --output jsonpath='{.status.phase}'

# 6. 删除恢复记录（不影响已恢复的资源）
velero restore delete <restore-name>  


4.备份位置与存储管理
4.1 备份存储位置
# 1. 查看备份存储位置
velero backup-location get
kubectl get backupstoragelocations -n velero

# 2. 创建备份存储位置
velero backup-location create secondary \
  --provider aws \
  --bucket velero-secondary \
  --config region=eu-west-1 \
  --access-mode ReadOnly

# 3. 设置默认备份位置
velero backup-location set default --name <location-name>

# 4. 验证存储位置连接
velero backup-location describe default --verify

# 5. 切换存储位置创建备份
velero backup create cross-region-backup \
  --storage-location secondary

4.2 备份生命周期管理
# 1. 设置备份保留策略
velero backup create retention-backup \
  --ttl 720h \  # 30天
  --expiration 2024-12-31T23:59:59Z

# 2. 自动清理过期备份
velero schedule create daily-cleanup \
  --schedule="@daily" \
  --ttl 0  # 立即过期（用于清理任务）

# 3. 手动删除旧备份
velero backup delete --older-than 720h

# 4. 保留最后 N 个备份
velero backup delete --keep 10

# 5. 基于策略的清理
velero backup delete \
  --selector backup-type=hourly \
  --older-than 24h

5.插件管理
# 1. 查看已安装插件
velero plugin get

# 2. 安装新插件
velero plugin add velero/velero-plugin-for-aws:v1.7.0

# 3. 卸载插件
velero plugin remove velero/velero-plugin-for-aws

# 4. 重启 Velero 使插件生效
kubectl delete pod -n velero -l component=velero

6.监控与告警

# 1. 启用指标
velero install --metrics-enabled

# 2. 查看 Velero 指标
kubectl port-forward -n velero deployment/velero 8085:8085
curl http://localhost:8085/metrics

# 3. 创建监控仪表板（Prometheus）
cat > velero-monitor.yaml <<EOF
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: velero
  namespace: velero
spec:
  selector:
    matchLabels:
      component: velero
  endpoints:
  - port: monitoring
    interval: 30s
EOF


7.健康检查

# 1. 检查 Velero 组件状态
velero version --client-only=false

# 2. 检查备份存储位置健康状况
velero backup-location describe default --verify

# 3. 检查调度执行状态
velero schedule describe <schedule-name> | grep -A 5 "Last Backup"

# 4. 检查 Restic 状态
kubectl get pods -n velero -l component=restic | grep -v Running

# 5. 检查备份完整性
velero backup describe <backup-name> | grep -E "Phase|Errors|Warnings"


