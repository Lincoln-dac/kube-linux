由于velero需要一个对象存储来存储备份文件，因此需要安装minio。
部署minio集群
1.创建目录
mkdir -p /app/minio/{bin,config,data1,data2,logs}
2. 下载minio二进制文件
wget -O /app/minio/bin/minio https://dl.minio.io/server/minio/release/linux-amd64/minio
注意：minio的版本需要和velero的版本兼容，否则会报错。
3. 配置minio
cat > /app/minio/config/config/minio << EOF
MINIO_ACCESS_KEY=minio
MINIO_SECRET_KEY=minio123
MINIO_PROMETHEUS_AUTH_TYPE=public
EOF
4.配置minio service(3个节点，每个节点2个数据目录，IP 10.204.51.64,10.204.51.65,10.204.51.66)
cat > /usr/lib/systemd/system/minio.service  << EOF
[Unit]
Description=MinIO
After=network.target

[Service]
User=mwopr
Group=mwopr
EnvironmentFile=-/app/minio/config/minio
ExecStart=/app/minio/bin/minio --config-dir /app/minio/config/ server  --address 0.0.0.0:19000 --console-address 0.0.0.0:19001 \
http://10.204.51.64:19000/app/minio/data1 \
http://10.204.51.64:19000/app/minio/data2 \
http://10.204.51.65:19000/app/minio/data1 \
http://10.204.51.65:19000/app/minio/data2 \
http://10.204.51.66:19000/app/minio/data1 \
http://10.204.51.66:19000/app/minio/data2
Restart=always
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF

以上配置完成后，每个节点都需要执行以上步骤。
5. 启动minio服务
systemctl daemon-reload
systemctl enable minio
systemctl start minio

6.配置nginx反向代理minio
/app/openresty/nginx/conf/servers/minio/minio.conf

upstream minio_api {
    least_conn;
    server 10.204.51.64:19000;
    server 10.204.51.65:19000;
    server 10.204.51.66:19000;
}

upstream minio_console {
    least_conn;
    server 10.204.51.64:19001;
    server 10.204.51.65:19001;
    server 10.204.51.66:19001;
}

server{
    listen       19000;
    server_name  192.168.51.51;

    ignore_invalid_headers off;
    client_max_body_size 0;
    proxy_buffering off;

    location / {
    proxy_set_header   X-Forwarded-Proto $scheme;
    proxy_set_header   Host              $http_host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_connect_timeout 300;
    proxy_http_version 1.1;
    chunked_transfer_encoding off;
    proxy_ignore_client_abort on;
    proxy_pass http://minio_api;
    }
}

server{
    listen       19001;
    server_name  10.204.51.51 ;

    ignore_invalid_headers off;
    client_max_body_size 0;
    proxy_buffering off;

    location / {
    proxy_set_header   X-Forwarded-Proto $scheme;
    proxy_set_header   Host              $http_host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_connect_timeout 300;
    proxy_http_version 1.1;
    chunked_transfer_encoding off;
    proxy_ignore_client_abort on;
    proxy_pass http://minio_console;
    }
}

7.登录minio控制台，配置bucket
http://10.204.51.51:19001
用户名：minio
密码：minio123
新建bucket：velero


8.部署velero
(1)下载velero-v1.4.2
wget https://github.com/vmware-tanzu/velero/releases/download/v1.4.2/velero-v1.4.2-linux-amd64.tar.gz
由于我的k8s版本较低,所以选择velero-v1.4.2-linux-amd64.tar.gz
解压velero-v1.4.2-linux-amd64.tar.gz
tar -zxvf velero-v1.4.2-linux-amd64.tar.gz
cd /app/velero-v1.4.2-linux-amd64
(2)创建credentials-velero 
cat > credentials-velero << EOF
[default]
aws_access_key_id=minio
aws_secret_access_key=minio123
EOF

执行base64 credentials-velero 
W2RlZmF1bHRdCmF3c19hY2Nlc3Nfa2V5X2lkID0gbWluaW8KYXdzX3NlY3JldF9hY2Nlc3Nfa2V5
ID0gbWluaW8xMjMKCg==
修改secrets-credentials.yaml
cat > secrets-credentials.yaml << EOF
apiVersion: v1
kind: Secret
metadata:
  name: cloud-credentials
  namespace: velero
type: Opaque
stringData:
  cloud-credentials: W2RlZmF1bHRdCmF3c19hY2Nlc3Nfa2V5X2lkID0gbWluaW8KYXdzX3NlY3JldF9hY2Nlc3Nfa2V5
ID0gbWluaW8xMjMKCg==
EOF

执行kubectl  apply -f secrets-credentials.yaml

(3)安装CRD
cd /app/velero-v1.4.2-linux-amd64/config
kubectl apply -f .

(4)部署velero
kubectl apply -f velero.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: velero
  namespace: velero
  labels:
    component: velero
spec:
  replicas: 1
  selector:
    matchLabels:
      deploy: velero
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
  template:
    metadata:
      labels:
        component: velero
        deploy: velero
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8085"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: velero
      restartPolicy: Always
      containers:
      - name: velero
        image: 10.204.209.253/common/velero:v1.4.2
        imagePullPolicy: IfNotPresent
        command:
          - /velero
        args:
          - server
          - --features=
        env:
        - name: VELERO_SCRATCH_DIR
          value: /scratch
        - name: VELERO_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: LD_LIBRARY_PATH
          value: /plugins
        - name: GOOGLE_APPLICATION_CREDENTIALS
          value: /credentials/cloud
        - name: AWS_SHARED_CREDENTIALS_FILE
          value: /credentials/cloud
        - name: AZURE_CREDENTIALS_FILE
          value: /credentials/cloud
        - name: ALIBABA_CLOUD_CREDENTIALS_FILE
          value: /credentials/cloud
        ports:
        - containerPort: 8085
          name: metrics
        resources:
          requests:
            cpu: 0.1
            memory: 500Mi
          limits:
            cpu: 1
            memory: 1Gi
        volumeMounts:
        - mountPath: /plugins
          name: plugins
        - mountPath: /scratch
          name: scratch
        - mountPath: /credentials
          name: cloud-credentials
        - mountPath: /etc/localtime
          name: localtime
      initContainers:
      - name: velero-plugin-for-aws
        image: 10.204.209.253/common/velero-plugin-for-aws:v1.0.0
        imagePullPolicy: IfNotPresent
        resources:
          requests:
            cpu: 0.1
            memory: 100Mi
          limits:
            cpu: 1
            memory: 500Mi
        volumeMounts:
        - mountPath: /target
          name: plugins
      volumes:
      - name: plugins
        emptyDir: {}
      - name: scratch
        emptyDir: {}
      - name: cloud-credentials
        secret:
          secretName: cloud-credentials
          defaultMode: 420
      - name: localtime
        hostPath:
          path: /etc/localtime

（5）创建BackupStorageLocation
cat > backupstoragelocation.yaml << EOF
apiVersion: velero.io/v1
kind: BackupStorageLocation
metadata:
  name: bls
  namespace: velero
spec:
  provider: aws
  objectStorage:
    bucket: velero
  config:
    region: minio
    s3Url: http://10.204.51.51:19000
    s3ForcePathStyle: "true"
  accessMode: ReadWrite
EOF

执行kubectl apply -f backupstoragelocation.yaml

（6）创建schedule
cat > schedule.yaml << EOF
apiVersion: velero.io/v1
kind: BackupStorageLocation
metadata:
  name: bls
  namespace: velero
spec:
  provider: aws
  objectStorage:
    bucket: velero
  config:
    region: minio
    s3Url: http://10.204.51.51:19000
    s3ForcePathStyle: "true"
  accessMode: ReadWrite
[root@k8s-node64 velero-v1.4.2]# cat schedule.yaml 
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: daily-full-backup
  namespace: velero
spec:
  schedule: "*/15 * * * *"
  template:
    ttl: 720h # 保留 30 天备份，可改
    includedNamespaces:
    - "*"      # 备份全部 namespace
    snapshotVolumes: false
    storageLocation: bls   # 使用 BSL “default”
EOF

(7)查看velero状态
kubectl get deployment -n velero
查看schedule
kubectl get schedule -n velero
查看备份
kubectl get backup -n velero